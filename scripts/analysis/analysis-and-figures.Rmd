---
title: "updated-analysis"
output: github_document
---

Load libraries

```{r}
library(sf)
library(tidyverse)
library(raster)
#library(ggpubr)
library(lsr) # includes t-test functions
library(stats) # includes different t-test functions
#library(rio) # for importing data
library(psych) # for descriptives
library(pwr) # for conducting a power analysis
library(zoo)
library(biscale)
library(tigris)
library(ggsignif)
library(ggpubr)
```

# Load in data with extracted richness values

Background (by state)

```{r message=FALSE, include=FALSE}
background <- read_csv("../data/summary_richness/fbackground_extract.csv") %>%
  dplyr::select(STUSPS, mammal_mean:area) %>%
  dplyr::rename(STATE = STUSPS)
```

US shapefile (for visualization below)

```{r message=FALSE, include=FALSE}
US <- st_read("../data/US_shp/s_11au16.shp")
```

Easement data (already filtered to GAP 1 and GAP 2) by region from NCED (more up to date than PADUS 2.0)

```{r warning=FALSE, message=FALSE, include = FALSE, cache=TRUE}

# easements1 <- read_csv("../data/summary_richness/easement_R1_extract.csv")
# easements2 <- read_csv("../data/summary_richness/easement_R2_extract.csv")
# easements3 <- read_csv("../data/summary_richness/easement_R3_extract.csv")
# easements4 <- read_csv("../data/summary_richness/easement_R4_extract.csv")
# easements5 <- read_csv("../data/summary_richness/easement_R5_extract.csv")
# easements6 <- read_csv("../data/summary_richness/easement_R6_extract.csv")
# easements7 <- read_csv("../data/summary_richness/easement_R7_extract.csv")
# easements8 <- read_csv("../data/summary_richness/easement_R8_extract.csv")
# easements9 <- read_csv("../data/summary_richness/easement_R9_extract.csv")
# easements10 <- read_csv("../data/summary_richness/easement_R10_extract.csv")
# easements11 <- read_csv("../data/summary_richness/easement_R11_extract.csv")
# easements12 <- read_csv("../data/summary_richness/easement_R12_extract.csv")
# 
# easements <- rbind(easements1, easements2,easements3, easements4, easements5, easements6, easements7,
#                    easements8, easements9, easements10, easements11, easements12)
# rm(easements1, easements2,easements3, easements4, easements5, easements6, easements7,
#                    easements8, easements9, easements10, easements11, easements12)

easements <- read_csv("../data/summary_richness/nced_extract.csv") |>
  filter(area > 1000) |>
  rename(GAP_Sts = GAT_Sts)

easements |> group_by(GAP_Sts) |> count()
# easements <- easements %>%
#   dplyr::select(Category, Mang_Type, Des_Tp, State_Nm, Date_Est, Access_Dt, GAP_Sts,EHoldTyp, Loc_Ds, Own_Type,
#          mammal_mean:area) %>% 
#   filter(Des_Tp == "CONE")|>
#   filter(area > 1000)
```

Fee data by region (all GAP codes)

```{r warning = FALSE, include=FALSE, cache=TRUE}
fee1 <- read_csv("../data/summary_richness/fee_R1_extract.csv")
fee2 <- read_csv("../data/summary_richness/fee_R2_extract.csv")
fee3 <- read_csv("../data/summary_richness/fee_R3_extract.csv")
fee4 <- read_csv("../data/summary_richness/fee_R4_extract.csv")
fee5 <- read_csv("../data/summary_richness/fee_R5_extract.csv")
fee6 <- read_csv("../data/summary_richness/fee_R6_extract.csv")
fee7 <- read_csv("../data/summary_richness/fee_R7_extract.csv")
fee8 <- read_csv("../data/summary_richness/fee_R8_extract.csv")
fee9 <- read_csv("../data/summary_richness/fee_R9_extract.csv")
fee10 <- read_csv("../data/summary_richness/fee_R10_extract.csv")
fee11 <- read_csv("../data/summary_richness/fee_R11_extract.csv")
fee12 <- read_csv("../data/summary_richness/fee_R12_extract.csv")

fee <- rbind(fee1, fee2,fee3, fee4, fee5, fee6, fee7,
                   fee8, fee9, fee10, fee11, fee12)
rm(fee1, fee2,fee3, fee4, fee5, fee6, fee7,
                   fee8, fee9, fee10, fee11, fee12)
fee <- fee %>%
  dplyr::select(Category, Mang_Type, Des_Tp, State_Nm, Date_Est, GAP_Sts, Own_Type,
         mammal_mean:area)  %>%
    mutate(Category = "fee") |>
  filter(area > 1000) |> filter(Mang_Type %in% c("FED", "STAT", "LOC"))

fee |> filter(GAP_Sts == "1"| GAP_Sts =="2") |>
  group_by(GAP_Sts) |> count()
fee12 <- fee |> filter(GAP_Sts == "1"| GAP_Sts =="2")
sum(easements$area)/sum(fee12$area)*100
```


# Figure 3:

Filter fee for protected GAP codes and select relevant variables
```{r}
fee_fig <- fee %>%
mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  filter(GAP_Sts == "1" | GAP_Sts == "2") %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, area, Date_Est) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu, 
         `Future Richness` = future)

ease_fig <- easements %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, Date_Est, area) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu,
         `Future Richness` = future)
```

```{r}
library(weights)
shapiro.test(dplyr::sample_n(fee_fig, 1000)$`Species Richness`)
wtd.t.test(x=fee_fig$`Species Richness`,
           y=ease_fig$`Species Richness`,
           weight=fee_fig$area,
           weighty=ease_fig$area,
           samedata=FALSE)

wtd.t.test(x=fee_fig$`Vulnerable Carbon`,
           y=ease_fig$`Vulnerable Carbon`,
           weight=fee_fig$area,
           weighty=ease_fig$area,
           samedata=FALSE)
stats::t.test(fee_fig$`Vulnerable Carbon`, ease_fig$`Vulnerable Carbon`)
```


Bind fee and easement data for figure 3

```{r fig.width=6, fig.height=3, dpi= 300}
fig3a <- easements %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, Date_Est, area) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu,
         `Future Richness` = future) %>%
  drop_na() %>%
  rbind(fee_fig) %>%
  mutate(time = ifelse(Date_Est <2000, NA, 
                       ifelse(Date_Est > 1999 & Date_Est < 2010, "2000-2009", "2010-2019"))) %>%
  drop_na() %>%
  dplyr::select(-c(Date_Est, area, RSR_all)) %>%
  pivot_longer(-c(Category, time)) %>%
  mutate(name = factor(name, levels = c("Species Richness", 
                                        "CRENVU Richness",
                                        "Future Richness",  
                                        "Vulnerable Carbon"))) %>%
  filter(Category == "fee") %>%
  ggplot(aes(x = time, y = value, col = Category)) + geom_boxplot() +
  facet_wrap(vars(name), ncol = 4, scales = "free_y") +
  stat_compare_means(aes(group = time), method = "t.test", vjust = 1, hjust = -1, label = "p.signif", color = "black", size=4) + 
  scale_color_manual(values=c("#E69F00")) +
  theme_classic() +
  theme(legend.position = "none",
        legend.title = element_blank()) +
  theme(axis.title.x = element_blank()) +
  labs(y = "mean value per parcel") + theme(text = element_text(size = 11))

fig3b <- easements %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, Date_Est, area) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu,
         `Future Richness` = future) %>%
  drop_na() %>%
  rbind(fee_fig) %>%
  mutate(time = ifelse(Date_Est <2000, NA, 
                       ifelse(Date_Est > 1999 & Date_Est < 2010, "2000-2009", "2010-2019"))) %>%
  drop_na() %>%
  dplyr::select(-c(Date_Est, area, RSR_all)) %>%
  pivot_longer(-c(Category, time)) %>%
  mutate(name = factor(name, levels = c("Species Richness", 
                                        "CRENVU Richness",
                                        "Future Richness",
                                        "Vulnerable Carbon"))) %>%
  filter(Category == "Easement") %>%
  ggplot(aes(x = time, y = value, col = Category)) + geom_boxplot() +
  facet_wrap(vars(name), ncol = 4, scales = "free_y") +
  stat_compare_means(aes(group = time), method = "wilcox.test", vjust = 1, hjust = -1, label = "p.signif", color = "black", size=4) + 
  scale_color_manual(values=c("#0072B2")) +
  theme_classic() +
  theme(legend.position = "none",
        legend.title = element_blank()) +
  theme(axis.title.x = element_blank()) +
  labs(y = "mean value per parcel") + theme(text = element_text(size = 11))
```

```{r fig3, fig.width=8, fig.height=5, dpi = 300}
library(patchwork)
figure3 <- fig3b/fig3a + plot_annotation(tag_levels = 'A')
ggsave("../analysis/figures/figure3.png", figure3, width = 8.5, height =5, dpi =300)
```

area stats 
```{r}
areas <- easements %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, Date_Est, area) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu,
         `Future Richness` = future) %>%
  drop_na() %>%
  rbind(fee_fig) %>%
  mutate(area = area/10000) %>%
  group_by(Category) %>%
  summarise(mean = mean(area),
            #SD = SD(area),
            sum = (sum(area)))

areas$sum[1]/areas$sum[2]
```

t-test stats for paper
```{r}
easements_ttest <- easements %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, Date_Est, area) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu,
         `Future Richness` = future) %>%
  drop_na() %>%
  rbind(fee_fig) %>%
  mutate(time = ifelse(Date_Est <2000, NA, 
                       ifelse(Date_Est > 1999 & Date_Est < 2010, "2000-2009", "2010-2019"))) %>%
  drop_na() %>%
  dplyr::select(-c(Date_Est, area, RSR_all)) %>%
  pivot_longer(-c(Category, time)) %>%
  mutate(name = factor(name, levels = c("Species Richness", 
                                        "CRENVU Richness",
                                        "Future Richness",
                                        "Vulnerable Carbon"))) %>%
  filter(Category == "Easement")

easements_ttest %>%
  group_by(name, time) %>%
  summarise(mean = mean(value),
            SD = sd(value))

easements_ttest %>% rename(variable = name) %>%
  dplyr::select(-Category) %>%
  group_by(time, variable) %>% 
  summarise(value = list(value)) %>% 
  spread(time, value) %>% 
  group_by(variable) %>%
  mutate(p_value = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$p.value,
         t_value = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$statistic,
         estimate_2000 = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$estimate[1],
         estimate_2010 = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$estimate[2],
         df =  wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$parameter)
```

```{r}
fee_ttest <- easements %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  dplyr::select(Category,carbon_vulnerable,richness_all:RSR_all, future, Date_Est, area) %>%
  dplyr::rename(`Species Richness` = richness_all,
         `Vulnerable Carbon` = carbon_vulnerable,
         `CRENVU Richness` =  richness_crenvu,
         `Future Richness` = future) %>%
  drop_na() %>%
  rbind(fee_fig) %>%
  mutate(time = ifelse(Date_Est <2000, NA, 
                       ifelse(Date_Est > 1999 & Date_Est < 2010, "2000-2009", "2010-2019"))) %>%
  drop_na() %>%
  dplyr::select(-c(Date_Est, area, RSR_all)) %>%
  pivot_longer(-c(Category, time)) %>%
  mutate(name = factor(name, levels = c("Species Richness", 
                                        "CRENVU Richness",
                                        "Future Richness",
                                        "Vulnerable Carbon"))) %>%
  filter(Category == "fee")

fee_ttest %>%
  group_by(name, time) %>%
  summarise(mean = mean(value),
            SD = sd(value))

fee_ttest %>% rename(variable = name) %>%
  dplyr::select(-Category) %>%
  group_by(time, variable) %>% 
  summarise(value = list(value)) %>% 
  spread(time, value) %>% 
  group_by(variable) %>%
  mutate(p_value = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$p.value,
         t_value = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$statistic,
         estimate_2000 = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$estimate[1],
         estimate_2010 = wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$estimate[2],
         df =  wilcox.test(unlist(`2000-2009`), unlist(`2010-2019`))$parameter)

```

# Figure 2:

```{r}
# easements already filtered to GAP1-2 before extraction 
ag_e <- easements %>%
    mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  mutate(Category = "easement") %>%
  group_by(Category) %>%
  mutate(total_area = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area) %>%
  mutate(richness_all = richness_all*perc_area,
         future = future*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(Category, total_area) %>%
  summarise(richness_all = sum(richness_all, na.rm = TRUE),
         future = sum(future, na.rm = TRUE),
         richness_crenvu= sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable = sum(carbon_vulnerable, na.rm = TRUE)) %>%
  ungroup()
```

```{r}
ag_f <- fee %>%
  filter(GAP_Sts == 1 | GAP_Sts == 2) %>%
      mutate(future = reptile_future + amphibian_future + bird_future + mammal_future) %>%
    mutate(Category = "fee") %>%
  group_by(Category) %>%
  mutate(total_area = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area) %>%
  mutate(richness_all = richness_all*perc_area,
         future = future*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(Category, total_area) %>%
  summarise(richness_all = sum(richness_all, na.rm = TRUE),
         future = sum(future, na.rm = TRUE),
         richness_crenvu= sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable = sum(carbon_vulnerable, na.rm = TRUE)) %>% 
  ungroup() 
```

```{r}
ag_b <- background %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  mutate(bind = "a") %>%
  group_by(bind) %>%
  mutate(total_area = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area) %>%
  mutate(richness_all = richness_all*perc_area,
         future = future*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(bind) %>%
  summarise(richness_all_b = sum(richness_all, na.rm = TRUE),
         future_all_b = sum(future, na.rm = TRUE),
         richness_crenvu_b= sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable_b = sum(carbon_vulnerable, na.rm = TRUE),
         total_area_ca = sum(area)) %>% 
  ungroup() 
```

public-private

Public = everything fee owned any gap status

```{r}
f2public <- fee %>%
  filter(Category == "fee") %>%
  mutate(future = plant_future  + tree_future + reptile_future + amphibian_future + bird_future + mammal_future) %>%
  mutate(Category = recode(Category, fee = "Public")) %>%
  group_by(Category) %>%
  mutate(total_area_public = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area_public) %>%
  mutate(richness_all = richness_all*perc_area,
         future = future*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(Category, total_area_public) %>%
  summarise(richness_all = sum(richness_all, na.rm = TRUE),
         future = sum(future, na.rm = TRUE),
         richness_crenvu = sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable = sum(carbon_vulnerable, na.rm = TRUE)) %>% 
  ungroup() 
```

```{r}
f2private <- f2public %>%
  dplyr::select(-Category) %>%
  cbind(ag_b) %>%
  mutate(area_private = total_area_ca-total_area_public) %>%
  mutate(richness_all = ((richness_all_b*total_area_ca)-(richness_all*total_area_public))/(area_private),
         future = ((future_all_b*total_area_ca)-(future*total_area_public))/(area_private),
         richness_crenvu = ((richness_crenvu_b*total_area_ca)-(richness_crenvu*total_area_public))/(area_private),
         carbon_vulnerable = ((carbon_vulnerable_b*total_area_ca)-(carbon_vulnerable*total_area_public))/(area_private)) %>%
  dplyr::select(richness_all:carbon_vulnerable, area_private) %>%
  mutate(Category = "Nonpublic") %>%
  rename(area = area_private)
```

public private

```{r}
public_private <- f2public %>%
  rename(area = total_area_public) %>%
  rbind(f2private) %>%
  mutate(bind= "a") %>%
  full_join(ag_b) %>%
  dplyr::mutate(`Species Richness` = (richness_all-richness_all_b)/richness_all_b,
                `Future Richness`  = (future-future_all_b)/future_all_b,
                `CRENVU Richness` = (richness_crenvu-richness_crenvu_b)/richness_crenvu_b,
                `Vulnerable Carbon` = (carbon_vulnerable-carbon_vulnerable_b)/carbon_vulnerable_b) %>%
  dplyr::select(`Species Richness`,`CRENVU Richness`, `Future Richness`, `Vulnerable Carbon`, Category) %>%
  pivot_longer(-Category) %>%
  mutate(name = factor(name, levels = c("Species Richness", 
                                        "CRENVU Richness",
                                        "Future Richness",
                                        "Vulnerable Carbon"))) %>%
  mutate(type = Category) %>%
  mutate(Category = plyr::revalue(Category, c(Private = "Easement", Public = "Fee") ))
```



```{r fig.height = 6, fig.width = 3, dpi = 300}
fig2a <- ag_e %>%
  rbind(ag_f) %>%
  mutate(bind = "a") %>%
  full_join(ag_b) %>%
  dplyr::select(-c(bind, total_area_ca)) %>%
  dplyr::mutate(`Species Richness` = (richness_all-richness_all_b)/richness_all_b,
                `Future Richness` = (future-future_all_b)/future_all_b,
                `CRENVU Richness` = (richness_crenvu-richness_crenvu_b)/richness_crenvu_b,
                `Vulnerable Carbon` = (carbon_vulnerable-carbon_vulnerable_b)/carbon_vulnerable_b) %>% 
  dplyr::select(Category,`Species Richness`, `CRENVU Richness`,`Future Richness`, `Vulnerable Carbon`) %>%
  pivot_longer(-Category) %>%
  mutate(name = factor(name, levels = c("Species Richness", 
                                        "CRENVU Richness",
                                        "Future Richness",
                                        "Vulnerable Carbon"))) %>%
  mutate(Category = ifelse(Category== "easement", "Easement", "Fee")) |>
  ggplot(aes(x = Category, y = value*100, fill = Category)) + 
  geom_bar(stat = "identity") +
    scale_fill_manual(values=c("#0072B2", "#E69F00", "black", "black")) +
  geom_point(public_private, mapping = aes(x = Category, y= as.numeric(value)*100,  
                                           group = type, 
                                           shape= type), stat = "identity", 
             position=position_dodge(width=0.8), size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(vars(name), scales = "free", ncol = 4) +
  scale_y_continuous(limits=c(-50,40)) +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
  theme(axis.title.x = element_blank()) +
  labs(y = "% difference from \n national mean value") +
  theme(text = element_text(size = 11.5))
```



```{r fig2, fig.width=8, fig.height=3.5, dpi = 300}
fig2a
ggsave("../analysis/figures/fig2.png", fig2a, width=8, height=3.5, dpi = 300)
```

# Figure 4: Bivariate map

```{r}
# The function that produces the colour matrix
colmat <- function(nbreaks = 3, breakstyle = "quantile",
                   upperleft = "#0096EB", upperright = "#820050", 
                   bottomleft = "#BEBEBE", bottomright = "#FFE60F",
                   xlab = "x label", ylab = "y label", plotLeg = TRUE,
                   saveLeg = FALSE) {
   # TODO - replace any tidyr, dplyr etc. functions with data.table #
  library(tidyverse)
  require(ggplot2)
  require(classInt)
  library(data.table)
  if (breakstyle == "sd") {
    warning("SD breaks style cannot be used.\nWill not always return the correct number of breaks.\nSee classInt::classIntervals() for details.\nResetting to quantile",
            call. = FALSE, immediate. = FALSE)
    breakstyle <- "quantile"}
  # The colours can be changed by changing the HEX codes for:
  # upperleft, upperright, bottomleft, bottomright
  # From http://www.joshuastevens.net/cartography/make-a-bivariate-choropleth-map/
  # upperleft = "#64ACBE", upperright = "#574249", bottomleft = "#E8E8E8", bottomright = "#C85A5A",
  # upperleft = "#BE64AC", upperright = "#3B4994", bottomleft = "#E8E8E8", bottomright = "#5AC8C8",
  # upperleft = "#73AE80", upperright = "#2A5A5B", bottomleft = "#E8E8E8", bottomright = "#6C83B5", 
  # upperleft = "#9972AF", upperright = "#804D36", bottomleft = "#E8E8E8", bottomright = "#C8B35A",
  # upperleft = "#DA8DC8", upperright = "#697AA2", bottomleft = "#E8E8E8", bottomright = "#73BCA0",
  # Similar to Teuling, Stockli, Seneviratnea (2011) [https://doi.org/10.1002/joc.2153]
  # upperleft = "#F7900A", upperright = "#993A65", bottomleft = "#44B360", bottomright = "#3A88B5",
  # Viridis style
  # upperleft = "#FEF287", upperright = "#21908D", bottomleft = "#E8F4F3", bottomright = "#9874A1",
  # Similar to Fjeldsa, Bowie, Rahbek 2012
  # upperleft = "#34C21B", upperright = "#FFFFFF", bottomleft = "#595757",  bottomright = "#A874B8",
  # Default from original source
  # upperleft = "#0096EB", upperright = "#820050", bottomleft= "#BEBEBE", bottomright = "#FFE60F",
  my.data <- seq(0, 1, .01)
  # Default uses terciles (Lucchesi and Wikle [2017] doi: 10.1002/sta4.150)
  my.class <- classInt::classIntervals(my.data,
                                       n = nbreaks,
                                       style = breakstyle,
                                       )
  my.pal.1 <- classInt::findColours(my.class, c(upperleft, bottomleft))
  my.pal.2 <- classInt::findColours(my.class, c(upperright, bottomright))
  col.matrix <- matrix(nrow = 101, ncol = 101, NA)
  for (i in 1:101) {
    my.col <- c(paste(my.pal.1[i]), paste(my.pal.2[i]))
    col.matrix[102 - i, ] <- classInt::findColours(my.class, my.col)
  }
  ## need to convert this to data.table at some stage.
  col.matrix.plot <- col.matrix %>%
    as.data.frame(.) %>% 
    mutate("Y" = row_number()) %>%
    mutate_at(.tbl = ., .vars = vars(starts_with("V")), .funs = list(as.character)) %>% 
    pivot_longer(data = ., cols = -Y, names_to = "X", values_to = "HEXCode") %>% 
    mutate("X" = as.integer(sub("V", "", .$X))) %>%
    distinct(as.factor(HEXCode), .keep_all = TRUE) %>%
    mutate(Y = rev(.$Y)) %>% 
    dplyr::select(-c(4)) %>%
    mutate("Y" = rep(seq(from = 1, to = nbreaks, by = 1), each = nbreaks),
           "X" = rep(seq(from = 1, to = nbreaks, by = 1), times = nbreaks)) %>%
    mutate("UID" = row_number())
  # Use plotLeg if you want a preview of the legend
  if (plotLeg) {
    p <- ggplot(col.matrix.plot, aes(X, Y, fill = HEXCode)) +
      geom_tile() +
      scale_fill_identity() +
      coord_equal(expand = FALSE) +
      theme_void() +
      theme(aspect.ratio = 1,
            axis.title = element_text(size = 10, colour = "black",hjust = 0.5, 
                                      vjust = 1),
            axis.title.y = element_text(size = 10, angle = 90, hjust = 0.5, vjust = 1)) +
      xlab(bquote(.(xlab) ~  symbol("\256"))) +
      ylab(bquote(.(ylab) ~  symbol("\256")))
    print(p)
    assign(
      x = "BivLegend",
      value = p,
      pos = .GlobalEnv
    )
  }
  # Use saveLeg if you want to save a copy of the legend
  if (saveLeg) {
    ggsave(filename = "bivLegend.pdf", plot = p, device = "pdf",
           path = "./", width = 4, height = 4, units = "in",
           dpi = 300)
  }
  seqs <- seq(0, 100, (100 / nbreaks))
  seqs[1] <- 1
  col.matrix <- col.matrix[c(seqs), c(seqs)]
  attr(col.matrix, "breakstyle") <- breakstyle
  attr(col.matrix, "nbreaks") <- nbreaks
  return(col.matrix)
}

# Function to assign colour-codes to raster data
# As before, by default assign tercile breaks
bivariate.map <- function(rasterx, rastery, colourmatrix = col.matrix,
                          export.colour.matrix = TRUE,
                          outname = paste0("colMatrix_rasValues", names(rasterx))) {
  # TO DO - replace raster with terra #
  require(raster)
  require(classInt)
  # export.colour.matrix will export a data.frame of rastervalues and RGB codes 
  # to the global environment outname defines the name of the data.frame
  quanx <- getValues(rasterx)
  tempx <- data.frame(quanx, quantile = rep(NA, length(quanx)))
  brks <- with(tempx, classIntervals(quanx,
                                    n = attr(colourmatrix, "nbreaks"),
                                    style = attr(colourmatrix, "breakstyle"))$brks)
  ## Add (very) small amount of noise to all but the first break
  ## https://stackoverflow.com/a/19846365/1710632
  brks[-1] <- brks[-1] + seq_along(brks[-1]) * .Machine$double.eps
  r1 <- within(tempx, quantile <- cut(quanx,
                                     breaks = brks,
                                     labels = 2:length(brks),
                                     include.lowest = TRUE))
  quantr <- data.frame(r1[, 2])
  quany <- getValues(rastery)
  tempy <- data.frame(quany, quantile = rep(NA, length(quany)))
  brksy <- with(tempy, classIntervals(quany,
                                     n = attr(colourmatrix, "nbreaks"),
                                     style = attr(colourmatrix, "breakstyle"))$brks)
  brksy[-1] <- brksy[-1] + seq_along(brksy[-1]) * .Machine$double.eps
  r2 <- within(tempy, quantile <- cut(quany,
                                     breaks = brksy,
                                     labels = 2:length(brksy),
                                     include.lowest = TRUE
  ))
  quantr2 <- data.frame(r2[, 2])
  as.numeric.factor <- function(x) {
    as.numeric(levels(x))[x]
  }
  col.matrix2 <- colourmatrix
  cn <- unique(colourmatrix)
  for (i in 1:length(col.matrix2)) {
    ifelse(is.na(col.matrix2[i]),
           col.matrix2[i] <- 1, col.matrix2[i] <- which(
             col.matrix2[i] == cn
           )[1]
    )
  }
  # Export the colour.matrix to data.frame() in the global env
  # Can then save with write.table() and use in ArcMap/QGIS
  # Need to save the output raster as integer data-type
  if (export.colour.matrix) {
    # create a dataframe of colours corresponding to raster values
    exportCols <- as.data.frame(cbind(
      as.vector(col.matrix2), as.vector(colourmatrix),
      t(col2rgb(as.vector(colourmatrix)))
    ))
    # rename columns of data.frame()
    colnames(exportCols)[1:2] <- c("rasValue", "HEX")
    # Export to the global environment
    assign(
      x = outname,
      value = exportCols,
      pos = .GlobalEnv
    )
  }
  cols <- numeric(length(quantr[, 1]))
  for (i in 1:length(quantr[, 1])) {
    a <- as.numeric.factor(quantr[i, 1])
    b <- as.numeric.factor(quantr2[i, 1])
    cols[i] <- as.numeric(col.matrix2[b, a])
  }
  r <- rasterx
  r[1:length(r)] <- cols
  return(r)
}
```


```{r}
if (!file.exists("../data/carbon-biodiv-bivariate.tif")) {
  #carbon_vulnerable <- raster("../data/carbon/Vulnerable_Carbon_2010/Vulnerable_C_Total_2010.tif")
  richness_all <- raster("../data/IUCN-precalculated/Richness_all.tif")
  #carbon_vulnerable_rs <- resample(carbon_vulnerable, richness_all, method = 'bilinear')
  #writeRaster(carbon_vulnerable_rs,       "../data/carbon/Vulnerable_Carbon_2010/Vulnerable_C_Total_2010_rs.tif")
  carbon_vulnerable_rs <- raster("../data/carbon/Vulnerable_Carbon_2010/Vulnerable_C_Total_2010_rs.tif")
  US_main <- US %>%
  dplyr::filter(STATE != "AK" & STATE != "HI")
  richness_all <- mask(richness_all, US_main)
  carbon_vulnerable_rs <- mask(carbon_vulnerable_rs, US_main)
  r <- stack(richness_all, carbon_vulnerable_rs)
  names(r) <- c("Biodiversity","Carbon")
  r <- crop(r, US_main)
  writeRaster(r, "../data/carbon-biodiv-bivariate.tif")
}

#read in your data 
biodiv <- raster("../data/carbon-biodiv-bivariate.tif", band = 1)
carbon <- raster("../data/carbon-biodiv-bivariate.tif", band = 2)
r <- stack(biodiv, carbon)
names(r) <- c("Biodiversity","Carbon")
```

```{r cache=TRUE}
# Define the number of breaks
nBreaks <- 5

# Create the colour matrix
col.matrixQ <- colmat(nbreaks = nBreaks, breakstyle = "quantile",
                       xlab = "Carbon", ylab = "Biodiversity", 
                       bottomright = "#77ac59", upperright = "#355149",
                       bottomleft = "#d3d3d3", upperleft = "#5e63ae",
                       saveLeg = FALSE, plotLeg = TRUE)


# create the bivariate raster
if (!file.exists("../data/bivmapQ.tif")) {
  bivmapQ <- bivariate.map(rasterx = r[["Carbon"]], rastery = r[["Biodiversity"]],
                          export.colour.matrix = TRUE,
                          colourmatrix = col.matrixQ)
  writeRaster(bivmapQ, "../data/bivmapQ.tif")
}
bivmapQ <- raster("../data/bivmapQ.tif")

# Convert to dataframe for plotting with ggplot
library(data.table)
bivMapDFQ <- setDT(as.data.frame(bivmapQ, xy = TRUE))
colnames(bivMapDFQ)[3] <- "BivValue"
bivMapDFQ <- melt(bivMapDFQ, id.vars = c("x", "y"),
                   measure.vars = "BivValue",
                   value.name = "bivVal",
                   variable.name = "Variable")

# Make the map using ggplot
map_q <- ggplot() +
    geom_raster(data = bivMapDFQ, aes(x = x, y = y, fill = bivVal)) +
      scale_fill_gradientn(colours = col.matrixQ, na.value = "transparent") + 
    theme_classic() + theme(panel.grid.major = element_blank(),
                            panel.grid.minor = element_blank()) +
    theme(text = element_text(size = 10, colour = "black")) +
    borders(colour = "black", size = 0.1) +
    coord_quickmap(expand = FALSE, xlim = c(-130,-65), ylim = c(24,52)) +
    theme(legend.position = "none",
          plot.background = element_blank(),
          strip.text = element_blank(), 
          #axis.text.y = element_blank(),
          #axis.text = element_blank(),
          axis.title = element_blank())

map_q <- map_q + inset_element(BivLegend, 0, 0, 0.2, 0.3)
```

Bar plot Lat:

```{r}
fee_line <- read_csv("../data/fee_lat_long.csv") %>%
  drop_na() %>% 
  filter(GAP_Sts == "1" | GAP_Sts == "2") %>%
  rename(x = lon, y = lat) %>%
  filter(x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(x) %>%
  summarise(value = sum(area, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Fee = (value-minval)/(maxval-minval)) %>%
  dplyr::select(x,Fee)

public_line <- read_csv("../data/fee_lat_long.csv") %>%
  drop_na() %>% 
  rename(x = lon, y = lat) %>%
  filter(x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(x) %>%
  summarise(value = sum(area, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Public = (value-minval)/(maxval-minval)) %>%
  dplyr::select(x,Public)

easement_line <- read_csv("../data/easement_lat_long.csv") %>%
  drop_na() %>% rename(x = lon, y = lat) %>%
  filter(x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(x) %>%
  summarise(value = sum(area, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Easement = (value-minval)/(maxval-minval)) %>%
  dplyr::select(x,Easement)

line_x <- public_line %>%
  #left_join(fee_line) %>%
  pivot_longer(-x)
```

```{r}
richness_pts <- as_tibble(rasterToPoints(r[[1]])) %>%
  drop_na() %>%
  filter(Biodiversity >0,
         x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(x) %>%
  summarise(value = mean(Biodiversity, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Biodiversity = (value-minval)/(maxval-minval)) %>%
  dplyr::select(x,Biodiversity)
  
carbon_pts <- as_tibble(rasterToPoints(r[[2]])) %>%
  drop_na() %>%
  filter(Carbon >0,
         x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(x) %>%
  summarise(value = mean(Carbon, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Carbon = (value-minval)/(maxval-minval)) %>%
  dplyr::select(x, Carbon)
```

```{r}
top <- richness_pts %>%
  left_join(carbon_pts) %>%
  pivot_longer(-x) %>%
  ggplot(aes(x = x, y = value, fill = name)) + 
  geom_density(stat = "identity", adjust = 10 , alpha = 0.3, lwd = 0) + 
  scale_fill_manual(values = c("#5e63ae", "#77ac59", "black", "black")) + xlim(-130,-65) +
  geom_line(data = line_x, aes(x = x, y = value), linetype = "dashed") +
  geom_text(data = subset(line_x, x == (-124)), aes(label = name, x = -124, y = value), size = 3, hjust = 1.4) +
  theme_classic() +
  theme(axis.text.y=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.title.x = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none")
```


Bar plot Long:
```{r}
fee_line <- read_csv("../data/fee_lat_long.csv") %>%
  drop_na() %>% rename(x = lon, y = lat) %>%
  filter(GAP_Sts == "1" | GAP_Sts == "2") %>%
  filter(x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(y) %>%
  summarise(value = sum(area, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Fee = (value-minval)/(maxval-minval)) %>%
  dplyr::select(y,Fee)

public_line <- read_csv("../data/fee_lat_long.csv") %>%
  drop_na() %>% 
  rename(x = lon, y = lat) %>%
  filter(x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(y) %>%
  summarise(value = sum(area, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Public = (value-minval)/(maxval-minval)) %>%
  dplyr::select(y,Public)


easement_line <- read_csv("../data/easement_lat_long.csv") %>%
  drop_na() %>% rename(x = lon, y = lat) %>%
  filter(x > (-130), x < (-65),
         y >22, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(y) %>%
  summarise(value = sum(area, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Easement = (value-minval)/(maxval-minval)) %>%
  dplyr::select(y,Easement)

line_y <- public_line %>%
  #left_join(fee_line) %>%
  pivot_longer(-y)
```

```{r}
richness_pts <- as_tibble(rasterToPoints(r[[1]])) %>%
  drop_na() %>%
  filter(Biodiversity >0,
         x > (-130), x < (-65),
         y > 26, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(y) %>%
  summarise(value = mean(Biodiversity, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), minval = min(value)) %>% ungroup() %>%
  mutate(Biodiversity = (value-minval)/(maxval-minval)) %>%
  dplyr::select(y,Biodiversity)
  
carbon_pts <- as_tibble(rasterToPoints(r[[2]])) %>%
  drop_na() %>%
  filter(Carbon >0,
         x > (-130), x < (-65),
         y > 26, y<52) %>%
  mutate(x = round(x, 0),
         y = round(y,0)) %>%
  group_by(y) %>%
  summarise(value = mean(Carbon, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(maxval = max(value), 
         minval = min(value)) %>% ungroup() %>%
  mutate(Carbon = (value-minval)/(maxval-minval)) %>%
  dplyr::select(y, Carbon)

side <- richness_pts %>%
  left_join(carbon_pts) %>%
  pivot_longer(-y) %>%
  ggplot(aes(x = y, y = value, fill = name)) + 
  geom_density(stat = "identity", alpha = 0.3, lwd = 0) + 
  scale_fill_manual(values = c("#5e63ae", "#77ac59", "black", "black")) + 
  xlim(23,52) +
  geom_line(data = line_y, aes(x = y, y = value), linetype = "dashed") +
  geom_text(data = subset(line_y, y == (49)), aes(label = name, x = 49, y = value), size = 3, hjust = 1, vjust = 1, angle=-90) +
  theme_classic() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none") + 
  coord_flip() 
side
```

```{r figure4, fig.width= 8, fig.height= 6, dpi=300}
library(patchwork)
layout <- "
AAAAAAAAAAAA##
CCCCCCCCCCCCBB
CCCCCCCCCCCCBB
CCCCCCCCCCCCBB
"
f4 <- top + side + map_q + plot_layout(design = layout)
f4
```

```{r}
# easements already filtered to GAP1-2 before extraction 
ag_e <- easements %>%
  rename(State_Nm = state) |>
  mutate(Category = "easement") %>%
  group_by(Category, State_Nm) %>%
  mutate(total_area = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area) %>%
  mutate(richness_all = richness_all*perc_area,
         RSR_all = RSR_all*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(Category, State_Nm, total_area) %>%
  summarise(richness_all = sum(richness_all, na.rm = TRUE),
         RSR_all = sum(RSR_all, na.rm = TRUE),
         richness_crenvu= sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable = sum(carbon_vulnerable, na.rm = TRUE)) %>%
  ungroup()
```

```{r}
ag_public <- fee %>%
  #filter(GAP_Sts == 1 | GAP_Sts == 2) %>%
    mutate(Category = "fee") %>%
  group_by(Category, State_Nm) %>%
  mutate(total_area = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area) %>%
  mutate(richness_all = richness_all*perc_area,
         RSR_all = RSR_all*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(Category, State_Nm, total_area) %>%
  summarise(richness_all = sum(richness_all, na.rm = TRUE),
         RSR_all = sum(RSR_all, na.rm = TRUE),
         richness_crenvu= sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable = sum(carbon_vulnerable, na.rm = TRUE)) %>% 
  ungroup()  %>%
  dplyr::select(State_Nm, total_area, richness_all, carbon_vulnerable)
```

```{r}
ag_fee <- fee %>%
  filter(GAP_Sts == 1 | GAP_Sts == 2) %>%
    mutate(Category = "fee") %>%
  group_by(Category, State_Nm) %>%
  mutate(total_area = sum(area)) %>%
  ungroup() %>%
  mutate(perc_area = area/total_area) %>%
  mutate(richness_all = richness_all*perc_area,
         RSR_all = RSR_all*perc_area,
         richness_crenvu= richness_crenvu*perc_area,
         carbon_vulnerable = carbon_vulnerable*perc_area) %>%
  group_by(Category, State_Nm, total_area) %>%
  summarise(richness_all = sum(richness_all, na.rm = TRUE),
         RSR_all = sum(RSR_all, na.rm = TRUE),
         richness_crenvu= sum(richness_crenvu, na.rm = TRUE),
         carbon_vulnerable = sum(carbon_vulnerable, na.rm = TRUE)) %>% 
  ungroup()  %>%
  dplyr::select(State_Nm, total_area, richness_all, carbon_vulnerable)
```

```{r}
ag_b <- background %>%
  rename(State_Nm = "STATE") %>%
  dplyr::select(State_Nm, richness_all:RSR_all, carbon_vulnerable, area) %>%
  rename(richness_all_b = richness_all,
         carbon_vulnerable_b = carbon_vulnerable,
         area_b = area) %>%
  dplyr::select(State_Nm,richness_all_b, carbon_vulnerable_b, area_b)
```

```{r fig.width=8, fig.height=3}
private_data <- ag_b %>%
  left_join(ag_public) %>%
  rename(area_public = total_area,
         richness_public = richness_all,
         carbon_public = carbon_vulnerable) %>%
  mutate(area_private = area_b-area_public,
         perc_private = area_private/area_b,
         perc_public = area_public/area_b) %>%
  mutate(richness_private = (richness_all_b - (richness_public*perc_public))/perc_private,
         carbon_private = (carbon_vulnerable_b - (carbon_public*perc_public))/perc_private) %>%
  mutate(rel_richness = (richness_private- richness_all_b)/richness_all_b,
         rel_carbon = (carbon_private-carbon_vulnerable_b)/carbon_vulnerable_b) %>%
  dplyr::select(State_Nm, rel_richness, rel_carbon, area_private) %>%
  mutate(mean_val = (rel_richness+rel_carbon)/2) 

  b <- private_data %>% 
      pivot_longer(-c(State_Nm, area_private, mean_val)) %>%
    ggplot(aes(x = reorder(State_Nm, -mean_val), y = value, fill = name)) + geom_bar(stat = "identity", position = "dodge", width = 0.8) +
  labs(y = "% difference of private land \n relative to state background") +
  scale_fill_manual(values = c("#77ac59","#5e63ae", "black", "black")) + 
  theme_classic() +
  theme(legend.position = "none",
         axis.text.x = element_text(color = "grey20", size = 7, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        axis.title.y = element_text(color = "black", size = 8),
        axis.title.x = element_blank())
```

```{r}
private_data
```

```{r fig.width=8, fig.height=3}
ease_data <- ag_e %>%
  left_join(ag_b) %>%
  mutate(rel_richness = (richness_all- richness_all_b)/richness_all_b,
         rel_carbon = (carbon_vulnerable-carbon_vulnerable_b)/carbon_vulnerable_b) %>%
  dplyr::select(State_Nm, rel_richness, rel_carbon) %>%
  mutate(mean_val = (rel_richness+rel_carbon)/2)
```

```{r fig.width=8, fig.height=3}
fee_data <- ag_fee %>%
  left_join(ag_b) %>%
  mutate(rel_richness = (richness_all- richness_all_b)/richness_all_b,
         rel_carbon = (carbon_vulnerable-carbon_vulnerable_b)/carbon_vulnerable_b) %>%
  dplyr::select(State_Nm, rel_richness, rel_carbon) %>%
  mutate(mean_val = (rel_richness+rel_carbon)/2)
```

```{r}
ease_count_st <- ease_data %>% filter(State_Nm != "PR") %>%
  mutate(color = ifelse(rel_richness>0 & rel_carbon>0,1,
                       ifelse(rel_richness<0 & rel_carbon>0,2,
                              ifelse(rel_richness>0 & rel_carbon<0,3,4)))) %>%
  group_by(color) %>% count()
```

```{r}
fee_count_st <- fee_data %>% filter(State_Nm != "PR") %>%
  mutate(color = ifelse(rel_richness>0 & rel_carbon>0,1,
                       ifelse(rel_richness<0 & rel_carbon>0,2,
                              ifelse(rel_richness>0 & rel_carbon<0,3,4)))) %>%
  group_by(color) %>% count()
```


```{r}
private_count_st <- private_data %>% filter(State_Nm != "PR") %>%
  mutate(color = ifelse(rel_richness>0 & rel_carbon>0,1,
                       ifelse(rel_richness<0 & rel_carbon>0,2,
                              ifelse(rel_richness>0 & rel_carbon<0,3,4)))) %>%
  group_by(color) %>% count()
```




```{r figure4_2, fig.width= 6, fig.height= 4, dpi=300}
library(patchwork)
layout <- "
AAAAAAAAAAAA##
CCCCCCCCCCCCBB
CCCCCCCCCCCCBB
CCCCCCCCCCCCBB
"

f4 <- top + side + map_q + plot_layout(design = layout)
f4
```


```{r}
background_shp <- states(cb = FALSE) %>%
  rename(State_Nm = STUSPS) %>%
  st_transform(crs= st_crs(2163))
```


```{r}
subnational_ease_map = ease_data %>% 
  mutate(color = ifelse(rel_richness>0 & rel_carbon>0,"both",
                       ifelse(rel_richness<0 & rel_carbon>0,"carbon",
                              ifelse(rel_richness>0 & rel_carbon<0,"biodiv","neither"))))

subnational_ease_map <- subnational_ease_map %>%
  left_join(background_shp)

subnational_ease_main <- ggplot() +
  geom_sf(data = subnational_ease_map, mapping = aes(fill = color, geometry= geometry), color = "black", size = 0.1, show.legend = FALSE) +
  coord_sf(crs = st_crs(2163), xlim = c(-2350000, 3000000), ylim = c(-2300000, 
         730000))+ theme_minimal() +
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +  theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid.major = element_blank())


AK_HI <- subnational_ease_map %>%
  dplyr::select(NAME, color) 
USA <- st_read("../data/US_shp/s_11au16.shp") %>%
  left_join(AK_HI)

alaska_ease <- ggplot() +
    geom_sf(data = USA,  aes(fill = color), color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(3467), xlim = c(-2400000, 1600000), ylim = c(200000, 
         2500000), expand = FALSE, datum = NA) +theme_minimal() +
   theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme() #+  theme(panel.border = element_rect(colour = "black", fill=NA))


hawaii_ease  <- ggplot() +
    geom_sf(data = USA, aes(fill = color),color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(4135), xlim = c(-161, -154), ylim = c(18, 
         23), expand = FALSE, datum = NA) +theme_minimal() +
     theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme() #+ theme(panel.border = element_rect(colour = "black", fill=NA))

ease <-subnational_ease_main +
 annotation_custom(
      grob = ggplotGrob(alaska_ease),
      xmin = -2800000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii_ease),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  ) 
```


```{r}
subnational_fee_map = fee_data %>% 
  mutate(color = ifelse(rel_richness>0 & rel_carbon>0,"both",
                       ifelse(rel_richness<0 & rel_carbon>0,"carbon",
                              ifelse(rel_richness>0 & rel_carbon<0,"biodiv","neither"))))

subnational_fee_map <- subnational_fee_map %>%
  left_join(background_shp)

subnational_fee_main <- ggplot() +
  geom_sf(data = subnational_fee_map, mapping = aes(fill = color, geometry= geometry), color = "black", size = 0.1, show.legend = FALSE) +
  coord_sf(crs = st_crs(2163), xlim = c(-2350000, 3000000), ylim = c(-2300000, 
         730000))+ theme_minimal() +
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid.major = element_blank())

AK_HI <- subnational_fee_map %>%
  dplyr::select(NAME, color) 
USA <- st_read("../data/US_shp/s_11au16.shp") %>%
  left_join(AK_HI)

alaska_fee <- ggplot() +
    geom_sf(data = USA,  aes(fill = color), color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(3467), xlim = c(-2400000, 1600000), ylim = c(200000, 
         2500000), expand = FALSE, datum = NA) +theme_minimal() +
   theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme() #+  theme(panel.border = element_rect(colour = "black", fill=NA))


hawaii_fee  <- ggplot() +
    geom_sf(data = USA, aes(fill = color),color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(4135), xlim = c(-161, -154), ylim = c(18, 
         23), expand = FALSE, datum = NA) +theme_minimal() +
     theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme() #+ theme(panel.border = element_rect(colour = "black", fill=NA))

fee <-subnational_fee_main +
 annotation_custom(
      grob = ggplotGrob(alaska_fee),
      xmin = -2800000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii_fee),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  ) 
```

```{r}
subnational_private_map = private_data %>%
  mutate(color = ifelse(rel_richness>0 & rel_carbon>0,"both",
                       ifelse(rel_richness<0 & rel_carbon>0,"carbon",
                              ifelse(rel_richness>0 & rel_carbon<0,"biodiv","neither"))))

  

subnational_private_map <- subnational_private_map %>%
  left_join(background_shp)

subnational_private_main <- ggplot() +
  geom_sf(data = subnational_private_map, mapping = aes(fill = color, geometry= geometry), color = "black", size = 0.1, show.legend = FALSE) +
  coord_sf(crs = st_crs(2163), xlim = c(-2350000, 3000000), ylim = c(-2300000, 
         730000))+ theme_minimal() +
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid.major = element_blank())

AK_HI <- subnational_private_map %>%
  dplyr::select(NAME, color) 
USA <- st_read("../data/US_shp/s_11au16.shp") %>%
  left_join(AK_HI)

alaska_private <- ggplot() +
    geom_sf(data = USA,  aes(fill = color), color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(3467), xlim = c(-2400000, 1600000), ylim = c(200000, 
         2500000), expand = FALSE, datum = NA) +theme_minimal() +
   theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme()# +  theme(panel.border = element_rect(colour = "black", fill=NA))


hawaii_private  <- ggplot() +
    geom_sf(data = USA, aes(fill = color),color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(4135), xlim = c(-161, -154), ylim = c(18, 
         23), expand = FALSE, datum = NA) +theme_minimal() +
     theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme() #+ theme(panel.border = element_rect(colour = "black", fill=NA))

private <-subnational_private_main +
 annotation_custom(
      grob = ggplotGrob(alaska_private),
      xmin = -2800000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii_private),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  ) 
```


```{r}
fee_subn <- ag_fee %>%
  mutate(richness_fee = richness_all,
         carbon_fee = carbon_vulnerable) %>%
  dplyr::select(State_Nm, richness_fee, carbon_fee)
ease_subn <- ag_e %>%
  mutate(richness_ease = richness_all,
         carbon_ease = carbon_vulnerable) %>%
  dplyr::select(State_Nm, richness_ease, carbon_ease) 

fee_ease_subn <- fee_subn %>%
  left_join(ease_subn) %>%
  drop_na() %>%
  mutate(diff_carbon = carbon_ease-carbon_fee,
         diff_richness = richness_ease- richness_fee) %>%
  mutate(color = ifelse(diff_richness>0 & diff_carbon>0,"both",
                       ifelse(diff_richness<0 & diff_carbon>0,"carbon",
                              ifelse(diff_richness>0 & diff_carbon<0,"biodiv","neither"))))

fee_ease_subn <- fee_ease_subn %>%
  left_join(background_shp)

fee_ease_subn_main <- ggplot() +
  geom_sf(data = fee_ease_subn, mapping = aes(fill = color, geometry= geometry), color = "black", size = 0.1, show.legend = FALSE) +
  coord_sf(crs = st_crs(2163), xlim = c(-2350000, 3000000), ylim = c(-2300000, 
         730000))+ theme_minimal() +
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  theme_minimal() +
  theme(axis.text = element_blank(),
        panel.grid.major = element_blank())

AK_HI <- fee_ease_subn %>%
  dplyr::select(NAME, color) 
USA <- st_read("../data/US_shp/s_11au16.shp") %>%
  left_join(AK_HI)

alaska_subn_protected <- ggplot() +
    geom_sf(data = USA,  aes(fill = color), color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(3467), xlim = c(-2400000, 1600000), ylim = c(200000, 
         2500000), expand = FALSE, datum = NA) +theme_minimal() +
   theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme()# +  theme(panel.border = element_rect(colour = "black", fill=NA))


hawaii_subn_protected  <- ggplot() +
    geom_sf(data = USA, aes(fill = color),color = "black", size = 0.1, show.legend = FALSE)+
     coord_sf(crs = st_crs(4135), xlim = c(-161, -154), ylim = c(18, 
         23), expand = FALSE, datum = NA) +theme_minimal() +
     theme(panel.border = element_rect(colour = "black", fill=NA)) +
  scale_fill_manual(values = c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")) +
  bi_theme() #+ theme(panel.border = element_rect(colour = "black", fill=NA))

fee_ease_subn <-fee_ease_subn_main +
 annotation_custom(
      grob = ggplotGrob(alaska_subn_protected),
      xmin = -2800000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii_subn_protected),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  ) 
```

```{r fig.height= 4, fig.width=4, dpi = 300}
fee_subn <- ag_fee %>%
  mutate(richness_fee = richness_all,
         carbon_fee = carbon_vulnerable)
ease_subn <- ag_e %>%
  mutate(richness_ease = richness_all,
         carbon_ease = carbon_vulnerable)

plot_df <- fee_subn %>%
  left_join(ease_subn, by = "State_Nm") %>%
  drop_na() %>%
  mutate(diff_carbon = carbon_ease-carbon_fee,
         diff_richness = richness_ease- richness_fee)

c("#5e63ae", 
                               "#355149",
                               "#77ac59",
                               "#d3d3d3")
subnational_plt <- plot_df |>
   ggplot(aes(x = diff_richness, y = diff_carbon))+ 
      annotate("rect", xmin = Inf, xmax = 0, ymin = Inf, ymax = 0, fill= "#355149")  + 
      annotate("rect", xmin = -Inf, xmax = 0, ymin = -Inf, ymax = 0 , fill= "#d3d3d3") + 
      annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = -Inf, fill= "#5e63ae") + 
      annotate("rect", xmin = 0, xmax = -Inf, ymin = Inf, ymax = 0, fill=  "#77ac59") + 
      geom_point() + xlim(-100,100)+ ylim(-100,100) +
  labs(x = "% difference species richness \n (easement and fee by state)",
       y = "% difference carbon \n (easement and fee by state)")

ggsave("figures/fig4c.png", subnational_plt, width = 3.8, height = 3.2, dpi = 300)
```

```{r figure4BC, fig.width=7, fig.height=4, dpi=300}
ggsave("figures/fig4b.png", fee_ease_subn, width = 7, height = 4, dpi = 300)
```

```{r}
#c1 <- fee_ease_subn %>% dplyr::filter(State_Nm != "PR") 

#subnational_private_map %>%
 # right_join(c1, by = "State_Nm") %>%
 # group_by(color.x) %>% count()

#fee_ease_subn %>% dplyr::filter(State_Nm != "PR") %>%
 # group_by(color) %>% count()
```


## figure 1

```{r}
filter_fun <- function(x) {
  x |>  
    dplyr::mutate(valid =st_is_valid(x)) %>% 
    dplyr::filter(valid=="TRUE") %>%
    filter(GAP_Sts==1|GAP_Sts==2) %>%
    filter(GIS_Acres>1) |> mutate(area = st_area(geometry))
}
```

```{r}
fee_R1 <- st_read("../data/PADUS/PAD_R1/PADUS2_1Fee_Region1.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R2 <- st_read("../data/PADUS/PAD_R2/PADUS2_1Fee_Region2.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R3 <- st_read("../data/PADUS/PAD_R3/PADUS2_1Fee_Region3.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R4 <- st_read("../data/PADUS/PAD_R4/PADUS2_1Fee_Region4.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R5 <- st_read("../data/PADUS/PAD_R5/PADUS2_1Fee_Region5.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000) 
fee_R6 <- st_read("../data/PADUS/PAD_R6/PADUS2_1Fee_Region6.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R7 <- st_read("../data/PADUS/PAD_R7/PADUS2_1Fee_Region7.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R8 <- st_read("../data/PADUS/PAD_R8/PADUS2_1Fee_Region8.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R9 <- st_read("../data/PADUS/PAD_R9/PADUS2_1Fee_Region9.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R10 <- st_read("../data/PADUS/PAD_R10/PADUS2_1Fee_Region10.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R11 <- st_read("../data/PADUS/PAD_R11/PADUS2_1Fee_Region11.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
fee_R12 <- st_read("../data/PADUS/PAD_R12/PADUS2_1Fee_Region12.shp") |>
  filter_fun() |> filter(as.numeric(area) >1000)
```

```{r}
# old easements data - updated with NCED 
# easement_R1 <- st_read("../data/PADUS/PAD_R1/PADUS2_1Easement_Region1.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R2 <- st_read("../data/PADUS/PAD_R2/PADUS2_1Easement_Region2.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R3 <- st_read("../data/PADUS/PAD_R3/PADUS2_1Easement_Region3.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R4 <- st_read("../data/PADUS/PAD_R4/PADUS2_1Easement_Region4.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R5 <- st_read("../data/PADUS/PAD_R5/PADUS2_1Easement_Region5.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000) |> filter(Comments != "GENERAL PLANNING ONLY-not a legal representation of the easement boundary.")
# easement_R6 <- st_read("../data/PADUS/PAD_R6/PADUS2_1Easement_Region6.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R7 <- st_read("../data/PADUS/PAD_R7/PADUS2_1Easement_Region7.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R8 <- st_read("../data/PADUS/PAD_R8/PADUS2_1Easement_Region8.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R9 <- st_read("../data/PADUS/PAD_R9/PADUS2_1Easement_Region9.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R10 <- st_read("../data/PADUS/PAD_R10/PADUS2_1Easement_Region10.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R11 <- st_read("../data/PADUS/PAD_R11/PADUS2_1Easement_Region11.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# easement_R12 <- st_read("../data/PADUS/PAD_R12/PADUS2_1Easement_Region12.shp") |>
#   filter_fun() |> filter(as.numeric(area) >1000)
# 
# easements <- rbind(easement_R1, easement_R2,easement_R3,
#                    easement_R4, easement_R5, easement_R6,
#                    easement_R7, easement_R8, easement_R9,
#                    easement_R10, easement_R11, easement_R12)
# 
# easements <- easements %>%
#   dplyr::select(Category, Mang_Type, Des_Tp, State_Nm, Date_Est, Access_Dt, GAP_Sts,EHoldTyp, Loc_Ds, Own_Type,
#         area) %>% 
#   filter(Des_Tp == "CONE")
```


```{r}
fee <- rbind(fee_R1, fee_R2, fee_R3,
             fee_R4, fee_R5, fee_R6,
             fee_R7, fee_R8, fee_R9,
             fee_R10, fee_R11, fee_R12)
fee <- fee %>%
  dplyr::select(Category, Mang_Type, Des_Tp, State_Nm, Date_Est, GAP_Sts, Own_Type,
         area)  %>%
    mutate(Category = "fee") |>
   filter(Mang_Type %in% c("FED", "STAT", "LOC"))
```

```{r}
nced <- st_read("../data/nced/NCED_Polygons_06232022.shp") 

nced <- nced |>
  dplyr::mutate(valid =st_is_valid(nced)) %>% 
  dplyr::filter(valid=="TRUE") %>%
  filter(gapcat == "1" | gapcat == "2") |>
  mutate(area = st_area(geometry)) 
st_crs(nced) <- crs(fee)

# rename etc..
nced <- nced |>
  rename(Date_Est = year_est,
         GAP_Sts = gapcat) |>
  mutate(Category = "Easement")  |>
  mutate(area = st_area(geometry))
```

```{r}
priority <- st_read("../data/Priority_index_summary.shp") |>
  mutate(high = quantile(Priority_i, .9),
         diff = Priority_i-high) |>
  dplyr::filter(diff>0) |>
  st_transform(crs = crs(fee))
st_crs(priority) <- crs(fee)
```


```{r}
usa <- st_read("../data/US_shp/s_11au16.shp")
```

```{r}
mainland <- ggplot() + 
  geom_sf(data = usa, fill = "#dcdcdc", lwd = 0.1)+
  geom_sf(data = priority, fill = "darkgrey",lwd = 0, alpha = 0.8) +
  geom_sf(data = nced, fill = "#0072B2",line = "#0072B2", lwd = 0) +
  geom_sf(data = fee, fill = "#E69F00",line = "#E69F00", lwd = 0) +
  coord_sf(crs = st_crs(2163), xlim = c(-2500000, 2500000), ylim = c(-2300000, 
         730000))+ theme_minimal() +
  theme(panel.border = element_rect(colour = "black", fill=NA))
mainland
```

```{r}
alaska <- ggplot() +
    geom_sf(data = usa, fill = "#dcdcdc", lwd = 0.1)+
  geom_sf(data = priority, fill = "darkgrey",lwd = 0, alpha = 0.9) +
  geom_sf(data = nced, fill = "#0072B2",line = "#0072B2", lwd = 0.01) +
  geom_sf(data = fee, fill = "#E69F00",line = "#E69F00", lwd = 0.01) +
     coord_sf(crs = st_crs(3467), xlim = c(-2400000, 1600000), ylim = c(200000, 
         2500000), expand = FALSE, datum = NA) +theme_minimal() +
   theme(panel.border = element_rect(colour = "black", fill=NA))
hawaii  <- ggplot() +
    geom_sf(data = usa, fill = "#dcdcdc", lwd = 0.1)+
  geom_sf(data = priority, fill = "darkgrey",lwd = 0, alpha = 0.9) +
  geom_sf(data = nced, fill = "#0072B2",line = "#0072B2", lwd = 0.01) +
  geom_sf(data = fee, fill = "#E69F00",line = "#E69F00", lwd = 0.01) +
     coord_sf(crs = st_crs(4135), xlim = c(-161, -154), ylim = c(18, 
         23), expand = FALSE, datum = NA) +theme_minimal() +
     theme(panel.border = element_rect(colour = "black", fill=NA))
```


```{r, fig.height= 5, fig.width = 6, dpi = 300}
map <- mainland +
 annotation_custom(
      grob = ggplotGrob(alaska),
      xmin = -2800000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  )
ggsave("figures/map.png",map, height= 5, width = 6, dpi = 300)
```

```{r} 
fee1b <- as_tibble(fee) |> 
  dplyr::select(Category, area) |>
  mutate(Category = "Fee") |>
  group_by(Category) |>
  summarise(area = sum(as.numeric(area), na.rm = TRUE))

ease1b <- as_tibble(nced) |> 
  dplyr::select(Category, area) |>
  group_by(Category) |>
  summarise(area = sum(as.numeric(area), na.rm = TRUE))

fig1b <- fee1b |> rbind(ease1b) |>
  ggplot(aes(x = Category, y = area/10^6/10^3, fill = Category)) + 
  scale_fill_manual(values=c("#0072B2", "#E69F00")) +
  geom_bar(stat = "identity", width=0.65, position=position_dodge(width=0.8)) +
  theme_minimal() +
  theme(axis.title.x =element_blank()) +
  theme(legend.title = element_blank()) + 
  theme(legend.position = "none") + ylab(bquote("total area"  ~(10^3*km^2))) +
   theme(axis.text=element_text(size=11),
        axis.title=element_text(size=11),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.box.background = element_rect(colour = "black"))
```

```{r} 
fee1c <- as_tibble(fee) |> dplyr::select(area, Category) |>
  mutate(Category = "Fee")
ease1c <- as_tibble(easements) |> dplyr::select(area, Category)

fig1c <- fee1c |>
  rbind(ease1c) |>
  filter(as.numeric(area) > 10000) |>
  ggplot(aes(x = Category, y = log(as.numeric(area)/10^6), fill = Category)) + 
  scale_fill_manual(values=c("#0072B2", "#E69F00")) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.title.x =element_blank()) +
  theme(legend.title = element_blank()) + 
  theme(legend.position = "none") + ylab(bquote("log(parcel area)" ~(km^2))) +
   theme(axis.text=element_text(size=11),
        axis.title=element_text(size=11),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.box.background = element_rect(colour = "black"))
```

```{r} 
fee1d <- as_tibble(fee) |> 
  dplyr::select(Date_Est, area, Category) |>
  group_by(Category, Date_Est) |>
  summarise(area = sum(as.numeric(area, na.rm = TRUE))) |>
  mutate(Date_Est = as.numeric(Date_Est)) |>
  arrange(Date_Est) |>
  mutate(cumsum = cumsum(area)/10^9)

ease1d <- as_tibble(easements) |> 
  dplyr::select(Date_Est, area, Category) |>
  group_by(Category, Date_Est) |>
  summarise(area = sum(as.numeric(area, na.rm = TRUE))) |>
  mutate(Date_Est = as.numeric(Date_Est)) |>
  arrange(Date_Est) |>
  mutate(cumsum = cumsum(area)/10^9)

fig1d <- fee1d |>
  rbind(ease1d) |>
  mutate(Date_Est = as.numeric(Date_Est)) |>
  filter(Date_Est>1900) |>
  ggplot(aes(x = Date_Est, y = cumsum, group = Category, color = Category)) + 
  scale_color_manual(values=c("#0072B2", "#E69F00")) +
  geom_line() +
  geom_vline(xintercept=2010, linetype="dashed") +
  theme_minimal() +
  scale_x_continuous(breaks=seq(1900, 2020, 40)) +
  theme(axis.title.x =element_blank()) +
  theme(legend.title = element_blank()) + 
  theme(legend.position = "none") + ylab(bquote("cumulative area"  ~(10^3*km^2))) +
   theme(axis.text=element_text(size=11),
        axis.title=element_text(size=11),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.box.background = element_rect(colour = "black"))

```

```{r}
priority_ease <- st_intersection(nced, priority) 
priority_ease_area <- sum(st_area(priority_ease))/10^9
ease_area <- sum(nced$area)/10^9
ease_area_pri_perc <- priority_ease_area/ease_area

priority_fee <- st_intersection(fee, priority)
priority_fee_area <- sum(st_area(priority_fee))/10^9
fee_area <- sum(fee$area)/10^9
fee_area_pri_perc <- priority_fee_area/fee_area

priority_ease_area/priority_fee_area

fig1e <- data.frame(
  Category = c("Easement", "Fee"),
  Priority = c(as.numeric(ease_area_pri_perc), as.numeric(fee_area_pri_perc))
) |>
  ggplot(aes(x = Category, y = Priority*100, fill = Category)) + 
  scale_fill_manual(values=c("#0072B2", "#E69F00")) +
  geom_bar(stat = "identity", width=0.65, position=position_dodge(width=0.8)) +
  theme_minimal() +
  theme(axis.title.x =element_blank()) +
  theme(legend.title = element_blank()) + 
  theme(legend.position = "none") + ylab("% area in priority zone") +
   theme(axis.text=element_text(size=11),
        axis.title=element_text(size=11),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.box.background = element_rect(colour = "black"))
```


```{r fig.width = 6, fig.height=2}
library(ggpubr)
fig1bottom <- ggarrange(fig1b,fig1c,fig1d,fig1e, nrow = 1, labels = c("A", "C", "D", "E"))
ggsave("figures/fig1bottom.png",fig1bottom, width = 10, height = 2.8, unit = "in", dpi =300)
```




```{r}
pri_e <- as_tibble(priority_ease) |> group_by(Category) |>
  summarise(priority_area = sum(as.numeric(area)))

pri_f <- as_tibble(priority_fee) |> group_by(Category) |>
  summarise(priority_area = sum(as.numeric(area)))
pri_area <- pri_e |>
  rbind(pri_f)

fee1b |> rbind(ease1b) |>
  left_join(pri_area) |>
  mutate(perc_priority = priority_area/area)
```


```{r}
pa_size<- as.tibble(pa_priority) %>%
  mutate(pa_ce = "pa") %>%
  group_by(WDPAID, pa_ce) %>%
  summarise(area = sum(area),
            priority = mean(Prirty_)) %>%
  mutate(unique_id = WDPAID)
ce_size<- as.tibble(ce_priority) %>%
  mutate(pa_ce = "ce") %>%
  group_by(uniqu_d, pa_ce) %>%
  summarise(area = sum(area),
            priority = mean(Prirty_)) %>%
  mutate(unique_id = uniqu_d)
```

```{r}
ce_size$unique_id <- as.numeric(ce_size$unique_id)
pa_size$unique_id <- as.numeric(pa_size$unique_id)
size_plot <- pa_size %>%
  bind_rows(ce_size) %>% 
  mutate(area = as.numeric(area)) %>%
  filter(priority <50)
size_plot %>% ggplot(aes(x = log(area), y = priority, col = pa_ce)) + geom_point(shape = 21,alpha = 1/5)
```

```{r}
pa_all<- as.tibble(pa_priority) %>%
  mutate(pa_ce = "pa",
         Priority_i = Prirty_) %>%
  group_by(pa_ce) %>%
  summarise(priority_i = sum(Priority_i*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>% 
  mutate(priority_i = priority_i/area) 
ce_all<- as.tibble(ce_priority) %>%
  mutate(pa_ce = "ce",
         Priority_i = Prirty_) %>%
  group_by(pa_ce) %>%
  summarise(priority_i = sum(Priority_i*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>% 
  mutate(priority_i = priority_i/area)
all_priority_i <- pa_all %>% bind_rows(ce_all) %>%
   mutate(crit = "all")
all_priority_i
```


```{r}
a <- size_plot %>% group_by(pa_ce) %>% summarise(area = sum(area)/10^9,
                                                 count = n()) %>%
  mutate(pa_ce = recode(pa_ce, pa = "Protected \nareas", ce = "Conservation \n Easements")) %>%
  ggplot(aes(x = pa_ce, y = area, fill = pa_ce)) + 
  scale_fill_manual(values=c("#0072B2", "#E69F00")) +
  geom_bar(stat = "identity", width=0.65, position=position_dodge(width=0.8)) +
  theme_minimal() +
  theme(axis.title.x =element_blank()) +
  theme(legend.title = element_blank()) + 
  theme(legend.position = "none") + ylab("Total area") +
   theme(axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.box.background = element_rect(colour = "black"))

b <- all_priority_i %>%
  mutate(pa_ce = recode(pa_ce, pa = "Protected \nareas", ce = "Conservation \n Easements")) %>%
  ggplot(aes(x = pa_ce, y =priority_i, fill = pa_ce)) +geom_bar(stat = "identity") %>%
  scale_fill_manual(values=c("#0072B2", "#E69F00")) +
  geom_bar(stat = "identity", width=0.65, position=position_dodge(width=0.8)) +
  theme_minimal() +
  theme(axis.title.x =element_blank()) +
  theme(legend.title = element_blank()) + 
  theme(legend.position = "none") + ylab("Mean priority index") + 
   theme(axis.text=element_text(size=8),
        axis.title=element_text(size=10),
        panel.border = element_rect(colour = "black", fill=NA),
        legend.box.background = element_rect(colour = "black"))
```

```{r, fig.height= 5, fig.width= 3, dpi= 600}
grid.arrange(a, b, nrow = 2)
```

```{r}
ce_priority_i <- as.tibble(ce_priority) %>%
  mutate(year_est = year_st,
         Priority_i = Prirty_) %>%
  group_by(year_est) %>%
  summarise(priority_i = sum(Priority_i*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>% 
  mutate(priority_i = priority_i/area,
         pa_ce = "ce") %>%
  rename(STATUS_YR = "year_est")
```

```{r}
pa_priority_i <- as.tibble(pa_priority) %>%
  mutate(STATUS_YR = STATUS_,
         Priority_i = Prirty_) %>%
  group_by(STATUS_YR) %>%
  summarise(priority_i = sum(Priority_i*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>% 
  mutate(priority_i = priority_i/area,
         pa_ce = "pa") 
```

```{r}
all_yrs <- pa_priority_i %>%
  bind_rows(ce_priority_i)
all_yrs <- as.data.frame(all_yrs)
 a<- all_yrs %>% filter(STATUS_YR >2000, STATUS_YR<2017) %>%
  ggplot(aes(x = STATUS_YR, y = priority_i, col = pa_ce)) +geom_line()
 
b<- all_yrs %>% filter(STATUS_YR>1980, STATUS_YR<2017) %>%
  ggplot(aes(x = STATUS_YR, y = area, col = pa_ce)) +geom_line()
grid.arrange(a, b, ncol = 1)
all_yrs %>% filter(STATUS_YR >1950) %>%
  group_by(pa_ce) %>%
  summarise(area = sum(area)/10^9)
```


```{r}
wdpa_usa <- st_read("../data/wdpa/wdpa_clean_usa.shp")
```

```{r}
ce <- st_read("../data/NCED_12182019_Shp/Conservation_Easements.shp")
```

```{r}
wdpa_map <- st_transform(wdpa_usa,st_crs(2163))
ce_map <- st_transform(ce,st_crs(2163))
```


```{r}
usa <- st_read("../data/US_shp/s_11au16.shp")
```

```{r}
mainland <- ggplot() + 
  geom_sf(data = usa, fill = "#DCDCDC", lwd = 0.1)+
  geom_sf(data = easements, fill = "#0072B2",lwd = 0.2) +
  geom_sf(data = fee, fill = "#E69F00",lwd = 0.1) +
  geom_sf(data = priority, fill = "grey",lwd = 0.2) +
  coord_sf(crs = st_crs(2163), xlim = c(-2500000, 2500000), ylim = c(-2300000, 
         730000))+ theme_minimal() +
  theme(panel.border = element_rect(colour = "black", fill=NA))
mainland
```

```{r}
alaska <- ggplot() +
    geom_sf(data = usa, fill = "#DCDCDC", lwd = 0)+
     geom_sf(data = ce_map, fill = "#0072B2", lwd= 0) +
     geom_sf(data = wdpa_map, fill = "#E69F00", lwd = 0, alpha = 0.5) +
     coord_sf(crs = st_crs(3467), xlim = c(-2400000, 1600000), ylim = c(200000, 
         2500000), expand = FALSE, datum = NA) +theme_minimal() +
   theme(panel.border = element_rect(colour = "black", fill=NA))
hawaii  <- ggplot() +
    geom_sf(data = usa, fill = "#DCDCDC", lwd = 0)+
       geom_sf(data = ce_map, fill = "#0072B2", color = "#0072B2") +
       geom_sf(data = wdpa_map, fill = "#E69F00", color = "#E69F00") +
     coord_sf(crs = st_crs(4135), xlim = c(-161, -154), ylim = c(18, 
         23), expand = FALSE, datum = NA) +theme_minimal() +
     theme(panel.border = element_rect(colour = "black", fill=NA))
```


```{r, fig.height= 5, fi.width = 6, dpi = 600}
mainland +
 annotation_custom(
      grob = ggplotGrob(alaska),
      xmin = -2800000,
      xmax = -2750000 + (1600000 - (-2400000))/2.5,
      ymin = -2450000,
      ymax = -2450000 + (2500000 - 200000)/2.5
  ) +
  annotation_custom(
      grob = ggplotGrob(hawaii),
      xmin = -1250000,
      xmax = -1250000 + (-154 - (-161))*120000,
      ymin = -2450000,
      ymax = -2450000 + (23 - 18)*120000
  )
```


```{r}
regions <- st_read("../data/cb_2018_us_division_500k.shp")
```

(1) priorities ce and pa
(2) averages for regions
(4) maps

```{r}
ce <- st_transform(ce, crs = st_crs(amp_priority))
pa_priority <- st_intersection(st_buffer(wdpa_usa,0), st_buffer(priority_index,0))
am_ce <- st_intersection(st_buffer(ce,0), st_buffer(amp_priority,0))
```

```{r}
ce_priority<- st_read("../data/ce_priority.shp")
pa_priority <-st_read("../data/pa_priority.shp")
```

```{r}
ce_priority_i <- as.tibble(ce_priority) %>%
  group_by(year_st) %>%
  summarise(priority_i = sum(Prirty_*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>% 
  mutate(priority_i = priority_i/area,
         pa_ce = "ce") %>%
  rename(STATUS_ = "year_st")
```

```{r}
pa_priority_i <- as.tibble(pa_priority) %>%
  group_by(STATUS_) %>%
  summarise(priority_i = sum(Prirty_*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>% 
  mutate(priority_i = priority_i/area,
         pa_ce = "pa") 
pa_priority_i
```

```{r}
a<- pa_priority_i %>%
  bind_rows(ce_priority_i) %>%
  filter(STATUS_ > 2010) %>%
  group_by(pa_ce) %>%
  summarise(priority_i = sum(priority_i*as.numeric(area)),
            area = sum(as.numeric(area)),
            unweighted = mean(priority_i),
            .groups = "drop") %>%
  mutate(priority_i = priority_i/area) %>%
  ggplot(aes(x = pa_ce, y =unweighted)) +geom_bar(stat = "identity") +
  
b <- pa_priority_i %>%
  bind_rows(ce_priority_i) %>%
  filter(STATUS_<2011) %>%
  group_by(pa_ce) %>%
  summarise(priority_i = sum(priority_i*as.numeric(area)),
            area = sum(as.numeric(area)),
            .groups = "drop") %>%
  mutate(priority_i = priority_i/area) %>%
  ggplot(aes(x = pa_ce, y =priority_i)) +geom_bar(stat = "identity") 
```
